<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Deriv R_75 Live Chart</title>
  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    #chart {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>

  <div id="chart"></div>

  <script>
    // Initialize once DOM and library are ready
    function initChart() {
      // Verify library is loaded
      if (typeof window.LightweightCharts === 'undefined') {
        console.error('LightweightCharts library not available');
        return;
      }

      const chartContainer = document.getElementById("chart");

      // Ensure container has dimensions
      if (!chartContainer.offsetWidth || !chartContainer.offsetHeight) {
        console.warn('Chart container has no dimensions');
        return;
      }

      // Get the library
      const lwc = window.LightweightCharts;
      console.log('LightweightCharts loaded:', lwc);

      // Create chart
      const chart = lwc.createChart(chartContainer, {
        layout: {
          background: { color: "#0f172a" },
          textColor: "#e5e7eb"
        },
        grid: {
          vertLines: { color: "#1e293b" },
          horzLines: { color: "#1e293b" }
        },
        timeScale: {
          timeVisible: true,
          secondsVisible: true
        }
      });

      console.log('Chart created:', chart);

      // Add candlestick series
      const series = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderVisible: false,
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
      });

      console.log('Series added:', series);

      // WebSocket connection
      const socket = new WebSocket(
        "wss://ws.derivws.com/websockets/v3?app_id=1089"
      );

      socket.onopen = () => {
        console.log("Connected to Deriv WebSocket");

        // Subscribe to R_75 OHLC (1 minute candles)
        socket.send(JSON.stringify({
          ohlc: "R_75",
          granularity: 60,
          subscribe: 1
        }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.msg_type === "ohlc") {
          const ohlc = data.ohlc;

          // Update chart
          series.update({
            time: ohlc.open_time,
            open: parseFloat(ohlc.open),
            high: parseFloat(ohlc.high),
            low: parseFloat(ohlc.low),
            close: parseFloat(ohlc.close)
          });
        }
      };

      socket.onerror = (err) => {
        console.error("WS Error:", err);
      };

      socket.onclose = () => {
        console.log("Disconnected from Deriv WebSocket");
      };
    }

    // Load library dynamically and initialize
    const primaryCDN = 'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js';
    const fallbackCDN = 'https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js';

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    loadScript(primaryCDN)
      .catch(() => {
        console.warn('Primary CDN failed, trying fallback...');
        return loadScript(fallbackCDN);
      })
      .then(() => {
        console.log('LightweightCharts loaded');
        initChart();
      })
      .catch(err => {
        console.error('Failed to load LightweightCharts from all sources', err);
        document.body.innerHTML = '<div style="padding: 20px; color: #ef4444;">Failed to load chart library. Please check your internet connection.</div>';
      });
  </script>

</body>

</html>